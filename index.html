<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>PDF 表单填写（A 路线）</title>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", Arial; margin: 16px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .btn { border:0; border-radius:10px; padding:10px 12px; cursor:pointer; background:#2563eb; color:white; font-weight:600; }
    .btn.secondary { background:#e5e7eb; color:#111827; }
    .btn.warn { background:#ef4444; }
    .muted { color:#6b7280; font-size:12px; margin-top:8px; }

    #stage { position: relative; display: inline-block; border: 1px solid #e5e7eb; border-radius: 12px; padding: 8px; }
    #pdfCanvas { display:block; border-radius: 8px; }
    #annHost { position:absolute; left:8px; top:8px; }

    /* 让表单控件更像 PDF 编辑器 */
    #annHost .annotationLayer input,
    #annHost .annotationLayer textarea,
    #annHost .annotationLayer select {
      background: transparent !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      padding: 0;
      margin: 0;
      font-size: 14px;
    }
    #annHost .annotationLayer input:focus,
    #annHost .annotationLayer textarea:focus,
    #annHost .annotationLayer select:focus {
      outline: 1px dashed #60a5fa !important;
      border-radius: 4px;
    }

    /* 手写签名覆盖层 */
    #sigWrap { position:absolute; display:none; z-index: 20; }
    #sigCanvas { border: 1px dashed #9ca3af; border-radius: 10px; background: rgba(255,255,255,0.9); touch-action: none; }
    .badge { padding:4px 8px; border-radius:999px; background:#111827; color:white; font-size:12px; }
  </style>

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
</head>

<body>
  <h1>PDF 表单填写（点哪填哪 / 勾选 / 签名 / 导出）</h1>

  <div class="row">
    <button id="loadTpl" class="btn secondary">加载模板（consent_form.pdf）</button>

    <label class="row">
      <span class="btn secondary">或上传 PDF</span>
      <input type="file" id="uploadPdf" accept="application/pdf" style="display:none;">
    </label>

    <label class="row" style="gap:6px">
      <input id="flattenToggle" type="checkbox" checked />
      <span>导出时定稿（flatten）</span>
    </label>

    <button id="exportBtn" class="btn">生成 PDF</button>
    <button id="openBtn" class="btn secondary" disabled>打开预览</button>
    <button id="downloadBtn" class="btn secondary" disabled>下载 PDF</button>

    <span class="badge" id="status">未加载</span>
  </div>

  <div id="stage">
    <canvas id="pdfCanvas"></canvas>
    <div id="annHost"></div>

    <div id="sigWrap">
      <canvas id="sigCanvas"></canvas>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="sigClear" class="btn warn" disabled>清空手写签名</button>
    <span class="muted">如果按钮无反应：请强制刷新（Ctrl+Shift+R）避免 GitHub Pages 缓存旧代码。</span>
  </div>

  <script type="module">
    import * as pdfjsLib from './pdf.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.mjs';

    const CONFIG = {
      templatePdf: 'consent_form.pdf',
      signatureFieldName: 'Signature',  // ← 改成你 PDF 里真实的 Name
      printNameFieldName: 'Print Name', // 可选
      dateFieldName: 'Date',            // 可选
    };

    let originalPdfBytes = null;
    let pdfDocProxy = null;
    let pageProxy = null;
    let viewport = null;
    let scale = 1.5;

    let generatedBlobUrl = null;

    let sigPad = null;

    const pdfCanvas = document.getElementById('pdfCanvas');
    const annHost = document.getElementById('annHost');
    const statusEl = document.getElementById('status');

    const sigWrap = document.getElementById('sigWrap');
    const sigCanvas = document.getElementById('sigCanvas');
    const sigClearBtn = document.getElementById('sigClear');

    const exportBtn = document.getElementById('exportBtn');
    const openBtn = document.getElementById('openBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    function setStatus(t){ statusEl.textContent = t; }

    function revokeBlobUrl(){
      if (generatedBlobUrl){
        URL.revokeObjectURL(generatedBlobUrl);
        generatedBlobUrl = null;
      }
      openBtn.disabled = true;
      downloadBtn.disabled = true;
    }

    function setGenerated(blob){
      revokeBlobUrl();
      if (!blob) return;
      generatedBlobUrl = URL.createObjectURL(blob);
      openBtn.disabled = false;
      downloadBtn.disabled = false;
    }

    document.getElementById('loadTpl').addEventListener('click', async ()=>{
      const res = await fetch(CONFIG.templatePdf);
      if (!res.ok){
        alert(`找不到 ${CONFIG.templatePdf}（请确认在仓库根目录且大小写一致）`);
        return;
      }
      originalPdfBytes = await res.arrayBuffer();
      await renderPreview(originalPdfBytes);
    });

    document.getElementById('uploadPdf').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      originalPdfBytes = await file.arrayBuffer();
      await renderPreview(originalPdfBytes);
    });

    async function renderPreview(bytes){
      setStatus('加载中...');
      revokeBlobUrl();

      const docParams = { data: bytes };
      if (pdfjsLib.AnnotationMode?.ENABLE_FORMS !== undefined){
        docParams.annotationMode = pdfjsLib.AnnotationMode.ENABLE_FORMS;
      }

      const loadingTask = pdfjsLib.getDocument(docParams);
      pdfDocProxy = await loadingTask.promise;

      pageProxy = await pdfDocProxy.getPage(1);
      viewport = pageProxy.getViewport({ scale });

      const ctx = pdfCanvas.getContext('2d');
      pdfCanvas.width = viewport.width;
      pdfCanvas.height = viewport.height;

      annHost.style.width = viewport.width + 'px';
      annHost.style.height = viewport.height + 'px';
      annHost.innerHTML = '';

      const renderParams = { canvasContext: ctx, viewport };
      if (pdfjsLib.AnnotationMode?.ENABLE_FORMS !== undefined){
        renderParams.annotationMode = pdfjsLib.AnnotationMode.ENABLE_FORMS;
      }
      await pageProxy.render(renderParams).promise;

      await renderAnnotationLayer();
      setupSignatureOverlay();

      // ✅ 调试：打印页面上出现的字段 name（你能用这个核对字段名）
      console.log('PDF.js 渲染出的表单元素：',
        [...annHost.querySelectorAll('input,textarea,select')].map(e=>({name:e.name, id:e.id, type:e.type, tag:e.tagName}))
      );

      setStatus('已加载（可填写）');
    }

    async function renderAnnotationLayer(){
      const annotations = await pageProxy.getAnnotations({ intent: 'display' });

      const layerDiv = document.createElement('div');
      layerDiv.className = 'annotationLayer';
      annHost.appendChild(layerDiv);

      if (!pdfjsLib.AnnotationLayer?.render){
        alert('你的 pdf.mjs 版本可能不支持表单渲染（AnnotationLayer.render 不存在）。请换更新的 pdf.mjs / pdf.worker.mjs。');
        return;
      }

      pdfjsLib.AnnotationLayer.render({
        viewport: viewport.clone({ dontFlip: true }),
        div: layerDiv,
        annotations,
        page: pageProxy,
        renderForms: true,
      });
    }

    function findFieldElByName(name){
      if (!name) return null;
      return annHost.querySelector(`[name="${CSS.escape(name)}"]`);
    }

    function setupSignatureOverlay(){
      sigWrap.style.display = 'none';
      sigClearBtn.disabled = true;
      sigPad = null;

      const target = findFieldElByName(CONFIG.signatureFieldName);
      if (!target) return;

      const stageRect = document.getElementById('stage').getBoundingClientRect();
      const rect = target.getBoundingClientRect();

      const left = rect.left - stageRect.left;
      const top = rect.top - stageRect.top;
      const width = rect.width;
      const height = rect.height;

      // 隐藏原字段
      target.style.opacity = '0';
      target.style.pointerEvents = 'none';

      sigWrap.style.display = 'block';
      sigWrap.style.left = left + 'px';
      sigWrap.style.top = top + 'px';

      const ratio = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      sigCanvas.style.width = Math.max(60, width) + 'px';
      sigCanvas.style.height = Math.max(30, height) + 'px';
      sigCanvas.width = Math.max(60, Math.floor(width)) * ratio;
      sigCanvas.height = Math.max(30, Math.floor(height)) * ratio;

      const c = sigCanvas.getContext('2d');
      c.setTransform(ratio, 0, 0, ratio, 0, 0);

      sigPad = new SignaturePad(sigCanvas, { backgroundColor: 'rgba(255,255,255,0)' });
      sigClearBtn.disabled = false;
    }

    sigClearBtn.addEventListener('click', ()=>{
      if (sigPad) sigPad.clear();
    });

    function collectDomValues(){
      const els = annHost.querySelectorAll('input,textarea,select');
      const out = [];
      els.forEach(el=>{
        const name = el.name || el.getAttribute('name') || '';
        if (!name) return;
        const tag = el.tagName.toLowerCase();
        const type = (el.getAttribute('type') || '').toLowerCase();
        if (tag === 'input' && type === 'checkbox'){
          out.push({ name, kind:'checkbox', value: !!el.checked });
        } else {
          out.push({ name, kind:'text', value: el.value || '' });
        }
      });
      return out;
    }

    exportBtn.addEventListener('click', async ()=>{
      if (!originalPdfBytes){
        alert('请先加载模板或上传 PDF。');
        return;
      }

      setStatus('生成中...');
      revokeBlobUrl();

      const pdfDoc = await PDFLib.PDFDocument.load(originalPdfBytes);
      const form = pdfDoc.getForm();

      const values = collectDomValues();

      // ✅ 先把 DOM 的值写回表单字段
      for (const item of values){
        try{
          if (item.kind === 'checkbox'){
            const cb = form.getCheckBox(item.name);
            item.value ? cb.check() : cb.uncheck();
          } else {
            const tf = form.getTextField(item.name);
            tf.setText(String(item.value ?? ''));
          }
        } catch(e){
          console.warn('写入字段失败：', item.name, e);
        }
      }

      // ✅ 嵌入手写签名（按字段 widget 的矩形）
      if (sigPad && !sigPad.isEmpty()){
        try{
          const pngDataUrl = sigPad.toDataURL('image/png');
          const png = await pdfDoc.embedPng(pngDataUrl);

          const field = form.getField(CONFIG.signatureFieldName);
          const widgets = field.acroField.getWidgets();
          if (widgets.length){
            const w = widgets[0];
            const rect = w.getRectangle();
            const page = w.getPage();
            page.drawImage(png, { x: rect.x, y: rect.y, width: rect.width, height: rect.height });
          }
        } catch(e){
          console.warn('签名嵌入失败：', e);
        }
      }

      // ✅ 定稿
      if (document.getElementById('flattenToggle').checked){
        try{ form.flatten(); } catch(e){ console.warn('flatten 失败：', e); }
      }

      const outBytes = await pdfDoc.save();
      setGenerated(new Blob([outBytes], { type:'application/pdf' }));
      setStatus('已生成');
      alert('已生成 PDF。');
    });

    openBtn.addEventListener('click', ()=>{
      if (!generatedBlobUrl) return;
      window.open(generatedBlobUrl, '_blank', 'noopener');
    });

    downloadBtn.addEventListener('click', ()=>{
      if (!generatedBlobUrl) return;
      const a = document.createElement('a');
      a.href = generatedBlobUrl;
      a.download = 'Filled.pdf';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // 自动加载模板（如果存在）
    try{
      const r = await fetch(CONFIG.templatePdf);
      if (r.ok){
        originalPdfBytes = await r.arrayBuffer();
        await renderPreview(originalPdfBytes);
      } else {
        setStatus('未找到模板');
      }
    } catch {
      setStatus('未加载');
    }
  </script>
</body>
</html>
