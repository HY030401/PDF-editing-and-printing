<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Consent Form - 填写 + 签名 + 导出</title>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", Arial; margin: 16px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .btn { border: 0; border-radius: 10px; padding: 10px 12px; cursor: pointer; background: #2563eb; color: white; font-weight: 600; }
    .btn.secondary { background: #e5e7eb; color: #111827; }
    .btn.warn { background: #ef4444; }
    .muted { color: #6b7280; font-size: 12px; }

    #stage { position: relative; display: inline-block; border: 1px solid #e5e7eb; border-radius: 12px; padding: 8px; }
    #pdfCanvas { display:block; border-radius: 8px; }
    #overlay { position:absolute; left:8px; top:8px; }

    .field { position:absolute; }
    .in {
      box-sizing:border-box;
      border:1px solid #94a3b8; border-radius:8px;
      padding:6px 8px; font-size:14px; background:#ffffffcc;
    }

    .check, .radio { width:18px; height:18px; transform: translate(-2px, -2px); }
    .sigCanvas { border:1px dashed #9ca3af; background:#fff; border-radius:10px; touch-action: none; }

    /* ✅ 内嵌预览区域 */
    #previewWrap { margin-top: 14px; display:none; }
    #previewFrame { width: 100%; height: 70vh; border: 1px solid #e5e7eb; border-radius: 12px; }
  </style>

  <!-- ✅ 按你当前仓库结构，从 /build/ 加载 PDF.js -->
  <script type="module">
    import * as pdfjsLib from './build/pdf.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './build/pdf.worker.mjs';
    window.pdfjsLib = pdfjsLib;
  </script>

  <!-- ✅ pdf-lib + 手写签名库 -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
</head>

<body>
  <h1>PDF 固定模板填写（文字 / 日期 / 勾选 / 单选 / 签名）</h1>

  <div class="row" style="margin-bottom:10px">
    <button id="loadTpl" class="btn secondary">加载模板（consent_form.pdf）</button>
    <button id="exportBtn" class="btn">生成 PDF</button>
    <button id="togglePreviewBtn" class="btn secondary" disabled>打开预览</button>
    <button id="downloadBtn" class="btn secondary" disabled>下载 PDF</button>
    <button id="sigClear" class="btn warn" disabled>清空手写签名</button>
  </div>

  <div id="stage">
    <canvas id="pdfCanvas"></canvas>
    <div id="overlay"></div>
  </div>

  <!-- ✅ 页面内嵌预览，不怕 window.open 被拦 -->
  <div id="previewWrap">
    <div class="row" style="margin:10px 0;">
      <div class="muted">预览（生成后的 PDF）</div>
      <button id="closePreviewBtn" class="btn secondary">关闭预览</button>
    </div>
    <iframe id="previewFrame"></iframe>
  </div>

  <div class="muted" style="margin-top:10px;">
    ✅ 根目录必须有：index.html、consent_form.pdf、build/pdf.mjs、build/pdf.worker.mjs
  </div>

  <script>
    /*****************************************************************
     * 字段配置（按 consent_form.pdf 的真实框/勾选框定位）
     * 坐标单位：PDF 点(pt)，原点在左下角（pdf-lib 使用的坐标系）
     * 页面尺寸：612 x 792 (Letter)
     *****************************************************************/
    const FIELDS = [
      { id:'firstName', type:'text',  page:0, x:151.8, y:647.6, w: 79.2, h:14.3, fontSize:12, placeholder:'First Name' },
      { id:'lastName',  type:'text',  page:0, x:300.6, y:648.5, w:107.5, h:14.3, fontSize:12, placeholder:'Last Name' },

      { id:'phone',     type:'text',  page:0, x:173.1, y:623.0, w: 79.1, h:14.3, fontSize:12, placeholder:'Phone Number' },
      { id:'email',     type:'text',  page:0, x:297.8, y:623.0, w:107.5, h:14.3, fontSize:12, placeholder:'E-mail' },

      { id:'dob',       type:'date',  page:0, x:119.2, y:597.5, w:107.5, h:14.2, fontSize:12 },

      { id:'hearGoogle', type:'check', page:0, x:204.1, y:573.7, size:12 },
      { id:'hearYelp',   type:'check', page:0, x:252.3, y:574.4, size:12 },
      { id:'hearFriend', type:'check', page:0, x:290.6, y:573.0, size:12 },
      { id:'hearPassby', type:'check', page:0, x:338.7, y:573.0, size:12 },

      { id:'sensitive', type:'radio', page:0,
        options: [
          { id:'sensYes', value:'YES', x:261.1, y:555.3 },
          { id:'sensNo',  value:'NO',  x:315.0, y:555.3 },
        ]
      },

      { id:'init1', type:'check', page:0, x:92.1, y:291.7, size:12 },
      { id:'init2', type:'check', page:0, x:92.1, y:261.9, size:12 },
      { id:'init3', type:'check', page:0, x:92.1, y:216.5, size:12 },
      { id:'init4', type:'check', page:0, x:92.1, y:185.4, size:12 },
      { id:'init5', type:'check', page:0, x:92.1, y:155.6, size:12 },
      { id:'init6', type:'check', page:0, x:92.1, y:127.2, size:12 },

      { id:'printName', type:'text', page:0, x:156.1, y:83.0, w:79.1, h:14.3, fontSize:12, placeholder:'Print Name' },
      { id:'sigPrint',  type:'text', page:0, x:310.0, y:83.0, w:130.0, h:14.3, fontSize:12, placeholder:'打印体签名（可选）' },

      { id:'signature', type:'sig',  page:0, x:310.0, y:55.0, w:130.0, h:35.0 },

      { id:'signDate',  type:'date', page:0, x:449.5, y:81.6, w:79.1, h:14.2, fontSize:12 },
    ];

    /*****************************************************************
     * DOM
     *****************************************************************/
    const pdfCanvas = document.getElementById('pdfCanvas');
    const overlay = document.getElementById('overlay');

    const exportBtn = document.getElementById('exportBtn');
    const togglePreviewBtn = document.getElementById('togglePreviewBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const sigClearBtn = document.getElementById('sigClear');

    const previewWrap = document.getElementById('previewWrap');
    const previewFrame = document.getElementById('previewFrame');
    const closePreviewBtn = document.getElementById('closePreviewBtn');

    /*****************************************************************
     * 状态
     *****************************************************************/
    let originalPdfBytes = null;
    let viewport = null;
    const scale = 1.5;

    let generatedBlobUrl = null; // 仅用于 iframe 预览
    let generatedBlob = null;    // ✅ 用于下载（更稳）
    let sigPad = null;

    /*****************************************************************
     * 1) 加载固定模板 PDF
     *****************************************************************/
    document.getElementById('loadTpl').onclick = async () => {
      try {
        const res = await fetch('consent_form.pdf', { cache: 'no-store' });
        if (!res.ok) throw new Error('fetch failed');
        originalPdfBytes = await res.arrayBuffer();
        await renderPreview(originalPdfBytes);
        alert('模板已加载。');
      } catch (e) {
        alert('找不到 consent_form.pdf：请确认它在仓库根目录，且大小写一致。');
      }
    };

    /*****************************************************************
     * 2) 渲染 PDF 预览（第一页）
     *****************************************************************/
    async function renderPreview(bytes) {
      const loadingTask = pdfjsLib.getDocument({ data: bytes });
      const pdfDocProxy = await loadingTask.promise;

      const page = await pdfDocProxy.getPage(1);
      viewport = page.getViewport({ scale });

      const ctx = pdfCanvas.getContext('2d');
      pdfCanvas.width = viewport.width;
      pdfCanvas.height = viewport.height;

      overlay.style.width = viewport.width + 'px';
      overlay.style.height = viewport.height + 'px';
      overlay.innerHTML = '';

      await page.render({ canvasContext: ctx, viewport }).promise;

      buildOverlayFields();

      // 清空导出结果
      setGenerated(null);
      hidePreview();
    }

    function getScaleFactors() {
      const pxPerPtX = viewport.width / viewport.viewBox[2];
      const pxPerPtY = viewport.height / viewport.viewBox[3];
      return { pxPerPtX, pxPerPtY };
    }

    function pdfPtToDomPx(xPt, yPt) {
      const { pxPerPtX, pxPerPtY } = getScaleFactors();
      const x = xPt * pxPerPtX;
      const y = (viewport.viewBox[3] - yPt) * pxPerPtY; // 翻转Y（DOM左上原点）
      return { x, y };
    }

    /*****************************************************************
     * 3) Overlay 固定控件
     *****************************************************************/
    function buildOverlayFields() {
      overlay.innerHTML = '';

      for (const f of FIELDS) {
        if (f.type === 'text' || f.type === 'date') {
          const d = pdfPtToDomPx(f.x, f.y);

          const input = document.createElement('input');
          input.id = f.id;
          input.className = 'field in';
          input.type = (f.type === 'date') ? 'date' : 'text';
          if (f.placeholder) input.placeholder = f.placeholder;

          input.style.left = d.x + 'px';
          input.style.top  = (d.y - (f.h || 18)) + 'px';
          input.style.width = (f.w ? `${f.w * getScaleFactors().pxPerPtX}px` : '180px');

          overlay.appendChild(input);
        }

        if (f.type === 'check') {
          const d = pdfPtToDomPx(f.x, f.y);

          const cb = document.createElement('input');
          cb.id = f.id;
          cb.className = 'field check';
          cb.type = 'checkbox';
          cb.style.left = d.x + 'px';
          cb.style.top  = (d.y - 14) + 'px';

          overlay.appendChild(cb);
        }

        if (f.type === 'radio') {
          const name = f.id;
          for (const opt of f.options) {
            const d = pdfPtToDomPx(opt.x, opt.y);

            const rb = document.createElement('input');
            rb.id = opt.id;
            rb.className = 'field radio';
            rb.type = 'radio';
            rb.name = name;
            rb.value = opt.value;

            rb.style.left = d.x + 'px';
            rb.style.top  = (d.y - 14) + 'px';

            overlay.appendChild(rb);
          }
        }

        if (f.type === 'sig') {
          const d = pdfPtToDomPx(f.x, f.y);
          const { pxPerPtX, pxPerPtY } = getScaleFactors();

          const cssW = Math.round(f.w * pxPerPtX);
          const cssH = Math.round(f.h * pxPerPtY);
          const ratio = Math.max(1, Math.floor(window.devicePixelRatio || 1));

          const canvas = document.createElement('canvas');
          canvas.id = f.id;
          canvas.className = 'field sigCanvas';
          canvas.style.left = d.x + 'px';
          canvas.style.top  = (d.y - cssH) + 'px';
          canvas.style.width = cssW + 'px';
          canvas.style.height = cssH + 'px';

          canvas.width = cssW * ratio;
          canvas.height = cssH * ratio;

          overlay.appendChild(canvas);

          sigPad = new SignaturePad(canvas, { backgroundColor: 'rgba(255,255,255,1)' });

          const ctx = canvas.getContext('2d');
          ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

          sigClearBtn.disabled = false;
        }
      }
    }

    sigClearBtn.addEventListener('click', () => {
      if (sigPad) sigPad.clear();
    });

    /*****************************************************************
     * 4) 生成 PDF（写回）
     *****************************************************************/
    function formatMMDD(dateValue) {
      if (!dateValue) return '';
      const parts = String(dateValue).split('-');
      if (parts.length !== 3) return dateValue;
      return `${parts[1]}/${parts[2]}`;
    }

    function getValueById(id) {
      const el = document.getElementById(id);
      return el ? (el.value || '') : '';
    }

    function getCheckedById(id) {
      const el = document.getElementById(id);
      return !!(el && el.checked);
    }

    function getRadioValue(groupId, fallback='') {
      const checked = document.querySelector(`input[type="radio"][name="${groupId}"]:checked`);
      return checked ? checked.value : fallback;
    }

    function setGenerated(blob) {
      // 清旧预览 url
      if (generatedBlobUrl) {
        URL.revokeObjectURL(generatedBlobUrl);
        generatedBlobUrl = null;
      }

      generatedBlob = blob;

      togglePreviewBtn.disabled = true;
      downloadBtn.disabled = true;

      if (!blob) return;

      // 预览用 url
      generatedBlobUrl = URL.createObjectURL(blob);

      togglePreviewBtn.disabled = false;
      downloadBtn.disabled = false;
    }

    exportBtn.addEventListener('click', async () => {
      if (!originalPdfBytes) {
        alert('请先点击“加载模板（consent_form.pdf）”。');
        return;
      }

      const pdfDoc = await PDFLib.PDFDocument.load(originalPdfBytes);
      const page = pdfDoc.getPages()[0];
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

      // 文本/日期
      for (const f of FIELDS) {
        if (f.type === 'text') {
          const v = getValueById(f.id).trim();
          if (!v) continue;
          page.drawText(v, { x: f.x, y: f.y, size: f.fontSize || 12, font, color: PDFLib.rgb(0,0,0) });
        }
        if (f.type === 'date') {
          const raw = getValueById(f.id);
          const v = (f.id === 'dob' || f.id === 'signDate') ? formatMMDD(raw) : raw;
          if (!v) continue;
          page.drawText(String(v), { x: f.x, y: f.y, size: f.fontSize || 12, font, color: PDFLib.rgb(0,0,0) });
        }
      }

      // checkbox：画框 + 对勾
      function drawCheckBox(x, y, size, checked) {
        page.drawRectangle({
          x, y, width: size, height: size,
          borderWidth: 1, borderColor: PDFLib.rgb(0,0,0),
          color: PDFLib.rgb(1,1,1),
        });
        if (checked) {
          page.drawLine({ start: { x: x + 2, y: y + size*0.45 }, end: { x: x + size*0.4, y: y + 2 }, thickness: 2, color: PDFLib.rgb(0,0,0) });
          page.drawLine({ start: { x: x + size*0.38, y: y + 2 }, end: { x: x + size - 2, y: y + size - 2 }, thickness: 2, color: PDFLib.rgb(0,0,0) });
        }
      }

      for (const f of FIELDS) {
        if (f.type === 'check') {
          drawCheckBox(f.x, f.y, f.size || 12, getCheckedById(f.id));
        }
      }

      // radio：画圆 + 实心点
      const sens = getRadioValue('sensitive', '');
      const sensField = FIELDS.find(x => x.type === 'radio' && x.id === 'sensitive');
      if (sensField) {
        for (const opt of sensField.options) {
          page.drawCircle({
            x: opt.x + 6, y: opt.y + 6,
            size: 6,
            borderWidth: 1,
            borderColor: PDFLib.rgb(0,0,0),
            color: PDFLib.rgb(1,1,1),
          });
          if (sens === opt.value) {
            page.drawCircle({
              x: opt.x + 6, y: opt.y + 6,
              size: 3,
              color: PDFLib.rgb(0,0,0),
            });
          }
        }
      }

      // 签名：优先手写，否则打印体签名
      const sigText = getValueById('sigPrint').trim();
      const sigField = FIELDS.find(x => x.id === 'signature');

      if (sigField) {
        if (sigPad && !sigPad.isEmpty()) {
          const pngDataUrl = sigPad.toDataURL('image/png');
          const png = await pdfDoc.embedPng(pngDataUrl);
          page.drawImage(png, { x: sigField.x, y: sigField.y, width: sigField.w, height: sigField.h });
        } else if (sigText) {
          page.drawText(sigText, { x: sigField.x, y: sigField.y + sigField.h * 0.35, size: 14, font, color: PDFLib.rgb(0,0,0) });
        }
      }

      const bytes = await pdfDoc.save();
      const blob = new Blob([bytes], { type: 'application/pdf' });
      setGenerated(blob);

      // 如果预览已打开，自动刷新 iframe
      if (previewWrap.style.display !== 'none' && generatedBlobUrl) {
        previewFrame.src = generatedBlobUrl;
      }

      alert('已生成 PDF。');
    });

    /*****************************************************************
     * 5) 预览：页面内嵌 iframe（不走 window.open）
     *****************************************************************/
    function showPreview() {
      if (!generatedBlobUrl) return;
      previewWrap.style.display = 'block';
      previewFrame.src = generatedBlobUrl;
      togglePreviewBtn.textContent = '关闭预览';
    }

    function hidePreview() {
      previewWrap.style.display = 'none';
      previewFrame.src = 'about:blank';
      togglePreviewBtn.textContent = '打开预览';
    }

    togglePreviewBtn.addEventListener('click', () => {
      if (previewWrap.style.display === 'none' || previewWrap.style.display === '') {
        showPreview();
      } else {
        hidePreview();
      }
    });

    closePreviewBtn.addEventListener('click', hidePreview);

    /*****************************************************************
     * 6) 下载：保存 Blob + 更稳的触发方式
     *****************************************************************/
    downloadBtn.addEventListener('click', () => {
      if (!generatedBlob) return;

      // 兼容极少数旧环境
      if (window.navigator && window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveOrOpenBlob(generatedBlob, 'Filled.pdf');
        return;
      }

      const url = URL.createObjectURL(generatedBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Filled.pdf';
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      a.remove();

      // 延迟释放，避免太快 revoke 导致下载失败
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    });
  </script>
</body>
</html>
