<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>PDF 表单填写 + 签名 + 导出</title>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", Arial; margin: 16px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .btn { border: 0; border-radius: 10px; padding: 10px 12px; cursor: pointer; background: #2563eb; color: white; font-weight: 600; }
    .btn.secondary { background: #e5e7eb; color: #111827; }
    .btn.warn { background: #ef4444; }
    .muted { color: #6b7280; font-size: 12px; }
    #stage { position: relative; display: inline-block; border: 1px solid #e5e7eb; border-radius: 12px; padding: 8px; }
    #pdfCanvas { display:block; border-radius: 8px; }
    #overlay { position:absolute; left:8px; top:8px; pointer-events:none; }
    .field { position:absolute; pointer-events:auto; }
    .in {
      box-sizing:border-box; border:1px solid #94a3b8; border-radius:8px;
      padding:6px 8px; font-size:14px; background:#ffffffcc;
    }
    .check { width:18px; height:18px; }
    .sigCanvas { border:1px dashed #9ca3af; background:#fff; border-radius:10px; touch-action: none; }
    .badge { padding: 4px 8px; border-radius: 999px; background:#111827; color:white; font-size:12px; }
    .kv { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; white-space: pre-wrap; }
  </style>

  <!-- ✅ ESM 模块加载本地 PDF.js -->
  <script type="module">
    import * as pdfjsLib from './pdf.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.mjs';
    window.pdfjsLib = pdfjsLib;
  </script>

  <!-- ✅ pdf-lib + 签名库 -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
</head>

<body>
  <h1>PDF 固定模板填写（勾选/文字/签名/日期）</h1>

  <div class="row" style="margin-bottom:10px">
    <button id="loadTpl" class="btn secondary">加载模板（consent_form.pdf）</button>

    <label class="row">
      <span class="btn secondary">或上传 PDF</span>
      <input type="file" id="uploadPdf" accept="application/pdf" style="display:none">
    </label>

    <button id="toggleCalibrate" class="btn secondary">标定模式：关</button>
    <span class="badge" id="pageInfo">Page: 1</span>

    <button id="exportBtn" class="btn">生成 PDF</button>
    <button id="openBtn" class="btn secondary" disabled>打开预览</button>
    <button id="downloadBtn" class="btn secondary" disabled>下载 PDF</button>
  </div>

  <div id="stage">
    <canvas id="pdfCanvas"></canvas>
    <div id="overlay"></div>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="sigClear" class="btn warn" disabled>清空手写签名</button>
    <span class="muted">手机上建议：生成后点“打开预览”，再用系统分享/存储/打印。</span>
  </div>

  <div class="muted" style="margin-top:10px">
    <div>标定模式说明：打开后，点击 PDF 上你想放字段的位置，会输出该点的 PDF 坐标（单位 pt，左下为原点）。复制到下面配置即可。</div>
    <div class="kv" id="calibrateOut"></div>
  </div>

  <script>
    /*****************************************************************
     * 1) 字段配置（你只需要改这里的坐标）
     * 坐标单位：PDF 点(pt)，原点在左下角
     * type:
     *  - text:   文本（input）
     *  - date:   日期（input[type=date]），导出时可格式化为 MM/DD
     *  - email:  邮箱
     *  - check:  复选框
     *  - sig:    手写签名框（canvas）
     *****************************************************************/
    const FIELDS = [
      // === 例子：你这份 ChicLash PDF 里大概会有这些 ===
      // 你需要用“标定模式”去点真实位置，然后填 x,y,w,h

      { id:'firstName', type:'text',  page:0, x:  0, y:  0, w:160, h:18, fontSize:12, placeholder:'First Name' },
      { id:'lastName',  type:'text',  page:0, x:  0, y:  0, w:160, h:18, fontSize:12, placeholder:'Last Name' },

      { id:'phone',     type:'text',  page:0, x:  0, y:  0, w:170, h:18, fontSize:12, placeholder:'Phone' },
      { id:'email',     type:'email', page:0, x:  0, y:  0, w:220, h:18, fontSize:12, placeholder:'E-mail' },

      // DOB: Month/Date only（导出自动转 MM/DD）
      { id:'dob',       type:'date',  page:0, x:  0, y:  0, w:140, h:18, fontSize:12 },

      // How you hear about us?
      { id:'hearGoogle', type:'check', page:0, x: 0, y: 0, size:14, label:'Google' },
      { id:'hearYelp',   type:'check', page:0, x: 0, y: 0, size:14, label:'Yelp' },
      { id:'hearFriend', type:'check', page:0, x: 0, y: 0, size:14, label:'Friend' },
      { id:'hearPassby', type:'check', page:0, x: 0, y: 0, size:14, label:'Pass By' },

      // Sensitive eyes? YES / NO
      { id:'sensitiveYes', type:'check', page:0, x: 0, y: 0, size:14, label:'YES' },
      { id:'sensitiveNo',  type:'check', page:0, x: 0, y: 0, size:14, label:'NO' },

      // Initial（你表格里 "Please Initial Below" 可能每条都要缩写）
      // 这里示例 6 个，你可增减
      { id:'init1', type:'text', page:0, x:0, y:0, w:40, h:18, fontSize:12, placeholder:'Init' },
      { id:'init2', type:'text', page:0, x:0, y:0, w:40, h:18, fontSize:12, placeholder:'Init' },
      { id:'init3', type:'text', page:0, x:0, y:0, w:40, h:18, fontSize:12, placeholder:'Init' },
      { id:'init4', type:'text', page:0, x:0, y:0, w:40, h:18, fontSize:12, placeholder:'Init' },
      { id:'init5', type:'text', page:0, x:0, y:0, w:40, h:18, fontSize:12, placeholder:'Init' },
      { id:'init6', type:'text', page:0, x:0, y:0, w:40, h:18, fontSize:12, placeholder:'Init' },

      // Print Name / Signature / Date
      { id:'printName', type:'text', page:0, x:0, y:0, w:180, h:18, fontSize:12, placeholder:'Print Name' },
      { id:'sigPrint',  type:'text', page:0, x:0, y:0, w:220, h:18, fontSize:12, placeholder:'打印体签名（可选）' },
      { id:'signature', type:'sig',  page:0, x:0, y:0, w:220, h:60 }, // 手写签名框
      { id:'signDate',  type:'date', page:0, x:0, y:0, w:140, h:18, fontSize:12 },
    ];

    /*****************************************************************
     * 2) 状态
     *****************************************************************/
    let originalPdfBytes = null;
    let pdfDocProxy = null;
    let viewport = null;
    let scale = 1.5;
    let currentPageIndex = 0; // 先做单页；后面可扩展多页

    let calibrateMode = false;

    let generatedBlobUrl = null;
    let sigPad = null;

    const pdfCanvas = document.getElementById('pdfCanvas');
    const overlay = document.getElementById('overlay');
    const calibrateOut = document.getElementById('calibrateOut');

    const exportBtn = document.getElementById('exportBtn');
    const openBtn = document.getElementById('openBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const sigClearBtn = document.getElementById('sigClear');

    /*****************************************************************
     * 3) 加载 PDF
     *****************************************************************/
    document.getElementById('loadTpl').onclick = async () => {
      const res = await fetch('consent_form.pdf');
      if (!res.ok) {
        alert('找不到 consent_form.pdf。请把 PDF 放在与 index.html 同目录，并检查大小写。');
        return;
      }
      originalPdfBytes = await res.arrayBuffer();
      await renderPreview(originalPdfBytes);
    };

    document.getElementById('uploadPdf').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      originalPdfBytes = await file.arrayBuffer();
      await renderPreview(originalPdfBytes);
    });

    /*****************************************************************
     * 4) 渲染预览
     *****************************************************************/
    async function renderPreview(bytes) {
      const loadingTask = pdfjsLib.getDocument({ data: bytes });
      pdfDocProxy = await loadingTask.promise;

      const page = await pdfDocProxy.getPage(currentPageIndex + 1);
      viewport = page.getViewport({ scale });

      const ctx = pdfCanvas.getContext('2d');
      pdfCanvas.width = viewport.width;
      pdfCanvas.height = viewport.height;

      overlay.style.width = viewport.width + 'px';
      overlay.style.height = viewport.height + 'px';

      await page.render({ canvasContext: ctx, viewport }).promise;

      document.getElementById('pageInfo').textContent = `Page: ${currentPageIndex + 1}`;
      buildOverlayFields();

      // 清空导出结果
      setGenerated(null);
    }

    /*****************************************************************
     * 5) 坐标换算：PDF(pt) <-> DOM(px)
     *****************************************************************/
    function getScaleFactors() {
      // viewport.viewBox = [xMin, yMin, widthPt, heightPt]
      const pxPerPtX = viewport.width / viewport.viewBox[2];
      const pxPerPtY = viewport.height / viewport.viewBox[3];
      return { pxPerPtX, pxPerPtY };
    }

    function pdfPtToDomPx(xPt, yPt) {
      const { pxPerPtX, pxPerPtY } = getScaleFactors();
      const x = xPt * pxPerPtX;
      const y = (viewport.viewBox[3] - yPt) * pxPerPtY; // 翻转Y
      return { x, y };
    }

    function domPxToPdfPt(xPx, yPx) {
      const { pxPerPtX, pxPerPtY } = getScaleFactors();
      const x = xPx / pxPerPtX;
      const y = (viewport.height - yPx) / pxPerPtY;
      return { x, y };
    }

    /*****************************************************************
     * 6) 生成 overlay 控件（按字段 id）
     *****************************************************************/
    function buildOverlayFields() {
      overlay.innerHTML = '';
      overlay.style.pointerEvents = 'auto';

      // 只渲染当前页的字段
      const pageFields = FIELDS.filter(f => f.page === currentPageIndex);

      for (const f of pageFields) {
        if (f.type === 'text' || f.type === 'email' || f.type === 'date') {
          const d = pdfPtToDomPx(f.x, f.y);

          const input = document.createElement('input');
          input.id = f.id;
          input.className = 'field in';
          input.type = (f.type === 'date') ? 'date' : (f.type === 'email' ? 'email' : 'text');
          if (f.placeholder) input.placeholder = f.placeholder;

          // y 是字段基线附近，这里把 input 往上抬一点，让它贴合视觉
          input.style.left = d.x + 'px';
          input.style.top  = (d.y - (f.h || 18)) + 'px';
          input.style.width = (f.w ? `${f.w * getScaleFactors().pxPerPtX}px` : '180px');
          overlay.appendChild(input);
        }

        if (f.type === 'check') {
          const d = pdfPtToDomPx(f.x, f.y);
          const cb = document.createElement('input');
          cb.id = f.id;
          cb.className = 'field check';
          cb.type = 'checkbox';
          cb.style.left = (d.x - 8) + 'px';
          cb.style.top  = (d.y - 12) + 'px';
          overlay.appendChild(cb);
        }

        if (f.type === 'sig') {
          const d = pdfPtToDomPx(f.x, f.y);
          const { pxPerPtX, pxPerPtY } = getScaleFactors();

          // canvas 尺寸（考虑 devicePixelRatio 让手机更清晰）
          const cssW = Math.round(f.w * pxPerPtX);
          const cssH = Math.round(f.h * pxPerPtY);
          const ratio = Math.max(1, Math.floor(window.devicePixelRatio || 1));

          const canvas = document.createElement('canvas');
          canvas.id = f.id;
          canvas.className = 'field sigCanvas';
          canvas.style.left = d.x + 'px';
          canvas.style.top  = (d.y - cssH) + 'px';
          canvas.style.width = cssW + 'px';
          canvas.style.height = cssH + 'px';

          canvas.width = cssW * ratio;
          canvas.height = cssH * ratio;

          overlay.appendChild(canvas);

          // 初始化 signature pad
          sigPad = new SignaturePad(canvas, { backgroundColor: 'rgba(255,255,255,1)' });

          // 把缩放比例应用到绘制坐标系统
          const ctx = canvas.getContext('2d');
          ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

          sigClearBtn.disabled = false;
        }
      }
    }

    sigClearBtn.addEventListener('click', () => {
      if (sigPad) sigPad.clear();
    });

    /*****************************************************************
     * 7) 标定模式：点 PDF 输出坐标
     *****************************************************************/
    document.getElementById('toggleCalibrate').addEventListener('click', () => {
      calibrateMode = !calibrateMode;
      document.getElementById('toggleCalibrate').textContent = `标定模式：${calibrateMode ? '开' : '关'}`;
      calibrateOut.textContent = calibrateMode
        ? '已开启：点击 PDF 任意位置输出坐标...\n'
        : '';
    });

    // 点击 stage：如果标定模式开启，输出 PDF 坐标
    document.getElementById('stage').addEventListener('click', (e) => {
      if (!calibrateMode || !viewport) return;

      // 计算点击点相对 overlay 左上角的位置
      const rect = overlay.getBoundingClientRect();
      const xPx = e.clientX - rect.left;
      const yPx = e.clientY - rect.top;

      const pt = domPxToPdfPt(xPx, yPx);
      const msg =
        `click(dom px)=(${xPx.toFixed(1)}, ${yPx.toFixed(1)}) -> pdf pt=(${pt.x.toFixed(1)}, ${pt.y.toFixed(1)})\n` +
        `示例配置：{ id:'xxx', type:'text', page:${currentPageIndex}, x:${pt.x.toFixed(1)}, y:${pt.y.toFixed(1)}, w:160, h:18, fontSize:12 }\n`;

      calibrateOut.textContent += msg;
    });

    /*****************************************************************
     * 8) 导出：写回 PDF（pdf-lib）
     *****************************************************************/
    function formatMMDD(dateValue) {
      // dateValue: YYYY-MM-DD (from input[type=date])
      if (!dateValue) return '';
      const parts = String(dateValue).split('-');
      if (parts.length !== 3) return dateValue;
      const mm = parts[1];
      const dd = parts[2];
      return `${mm}/${dd}`;
    }

    function readFieldValue(f) {
      const el = document.getElementById(f.id);
      if (!el) return null;
      if (f.type === 'check') return !!el.checked;
      if (f.type === 'date') return formatMMDD(el.value); // 关键：DOB Month/Date only
      return el.value || '';
    }

    function setGenerated(blob) {
      // 清理旧 URL
      if (generatedBlobUrl) {
        URL.revokeObjectURL(generatedBlobUrl);
        generatedBlobUrl = null;
      }
      openBtn.disabled = true;
      downloadBtn.disabled = true;

      if (!blob) return;

      generatedBlobUrl = URL.createObjectURL(blob);
      openBtn.disabled = false;
      downloadBtn.disabled = false;
    }

    exportBtn.addEventListener('click', async () => {
      if (!originalPdfBytes) {
        alert('请先加载模板或上传 PDF。');
        return;
      }

      const pdfDoc = await PDFLib.PDFDocument.load(originalPdfBytes);
      const pages = pdfDoc.getPages();
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

      // 分页写入（你目前只一页，但这样以后好扩展）
      for (const f of FIELDS) {
        const page = pages[f.page];
        if (!page) continue;

        if (f.type === 'text' || f.type === 'email' || f.type === 'date') {
          const value = readFieldValue(f);
          if (!value) continue;

          page.drawText(String(value), {
            x: f.x,
            y: f.y,
            size: f.fontSize || 12,
            font,
            color: PDFLib.rgb(0, 0, 0),
          });
        }

        if (f.type === 'check') {
          const checked = readFieldValue(f);
          // 用 ☑/☐ 简单稳定（注意：有些 PDF 字体可能不支持该字符，如果你遇到方块字，我可以改成画线/画对勾路径）
          page.drawText(checked ? '☑' : '☐', {
            x: f.x,
            y: f.y,
            size: f.size || 14,
            font,
            color: PDFLib.rgb(0, 0, 0),
          });
        }

        if (f.type === 'sig') {
          // 如果用户填了“打印体签名”，你可以选择覆盖手写（或两者都写）
          const sigPrintField = FIELDS.find(x => x.id === 'sigPrint');
          const sigPrintValue = sigPrintField ? readFieldValue(sigPrintField) : '';

          if (sigPrintValue) {
            // 有打印体签名：写打印体到 signature 位置附近（你也可以改写到另一个位置）
            page.drawText(String(sigPrintValue), {
              x: f.x,
              y: f.y + (f.h ? f.h * 0.35 : 15),
              size: 14,
              font,
              color: PDFLib.rgb(0, 0, 0),
            });
          } else if (sigPad && !sigPad.isEmpty()) {
            // 手写签名：嵌入 PNG
            const pngDataUrl = sigPad.toDataURL('image/png');
            const png = await pdfDoc.embedPng(pngDataUrl);
            page.drawImage(png, { x: f.x, y: f.y, width: f.w, height: f.h });
          }
        }
      }

      const bytes = await pdfDoc.save();
      const blob = new Blob([bytes], { type: 'application/pdf' });
      setGenerated(blob);
      alert('已生成 PDF。手机端建议点“打开预览”再打印/分享。');
    });

    openBtn.addEventListener('click', () => {
      if (!generatedBlobUrl) return;
      window.open(generatedBlobUrl, '_blank', 'noopener');
    });

    downloadBtn.addEventListener('click', () => {
      if (!generatedBlobUrl) return;
      const a = document.createElement('a');
      a.href = generatedBlobUrl;
      a.download = 'Filled.pdf';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

  </script>
</body>
</html>
